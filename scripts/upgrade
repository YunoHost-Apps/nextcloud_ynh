#!/bin/bash

source _common.sh
source /usr/share/yunohost/helpers

upgrade_type=$(ynh_check_app_version_changed)

#=================================================
# ENSURE DOWNWARD COMPATIBILITY
#=================================================
ynh_script_progression --message="Ensuring downward compatibility..."

# Remove the option backup_core_only if it's in the settings.yml file
ynh_app_setting_delete --app=$app --key=backup_core_only

# If phpflags doesn't exist, create it
if [ -z "${phpflags:-}" ]; then
	phpflags="--define apc.enable_cli=1"
	ynh_app_setting_set --app=$app --key=phpflags --value=$phpflags
fi

# Delete existing ini configuration file (backward compatibility)
if [ -f /etc/php/$YNH_PHP_VERSION/fpm/conf.d/20-$app.ini ]; then
    ynh_secure_remove --file=/etc/php/$YNH_PHP_VERSION/fpm/conf.d/20-$app.ini
fi

#=================================================
# SPECIFIC UPGRADE
#=================================================
# MAKE SEQUENTIAL UPGRADES FROM EACH MAJOR
# VERSION TO THE NEXT ONE
#=================================================

current_version=$(grep OC_VersionString "$install_dir/version.php" | cut -d\' -f2)
current_major_version=${current_version%%.*}

# Define a function to execute commands with `occ`
exec_occ() {
    # Backward compatibility to upgrade from older versions
    if [ $current_major_version = "last" ] || [ $current_major_version -ge 26 ]
    then
        NEXTCLOUD_PHP_VERSION="8.2"
    elif [ $current_major_version -ge 24 ]
    then
        NEXTCLOUD_PHP_VERSION="8.1"
    elif [ $current_major_version -ge 18 ]
    then
        NEXTCLOUD_PHP_VERSION="7.4"
    else
        NEXTCLOUD_PHP_VERSION="7.1"
    fi

    # NB : be super careful when designing this part of the code, because calling ynh_install_app_dependencies 
    # will do magic regarding php configuration and $phpversion when the php version of the dependencies changes ...
    phpversion=$(ynh_app_setting_get --app=$app --key=phpversion)
    if [[ "$NEXTCLOUD_PHP_VERSION" != "$phpversion" ]]; then
        local pkg_dependencies="$(dpkg-query --show --showformat='${Depends}' ${app}-ynh-deps)"
        pkg_dependencies="${pkg_dependencies//$phpversion/$NEXTCLOUD_PHP_VERSION}"
        ynh_install_app_dependencies "$pkg_dependencies"
    fi 
(cd "$install_dir" && ynh_exec_as "$app" \
    php$NEXTCLOUD_PHP_VERSION --define apc.enable_cli=1 occ --no-interaction --no-ansi "$@")
}

#=================================================
# HANDLE DATABASE MIGRATION FROM MYSL TO PSQL
#=================================================

# If we're moving through version 28.0.1~ynh2 (in which the switch to psql is made)
if ynh_compare_current_package_version --comparison lt --version 28.0.1~ynh2
then
    # Double-check the MySQL DB is here
    if ! mysql -e "USE $db_name" 2>/dev/null 
    then
        ynh_print_warn "Uhoh? The Nextcloud MySQL DB doesn't exist? We are supposed to move it to PostgreSQL... Maybe it was already migrated?"
        # Double check the psql is not empty, otherwise big whoops?
        if [[ "$(ynh_psql_execute_as_root --database=$db_name --sql="\dt" 2>/dev/null | wc -l)" == 0 ]]
        then
                ynh_die "Apparently the PostgreSQL DB is also empty, this is kind of worrying, what happened?!"
        else
                ynh_print_warn "Apparently the PostgreSQL DB is not empty, so this is probably OK?"
        fi
    else
        ynh_print_info --message="Migrating to PostgreSQL database..."
        ynh_exec_warn_less exec_occ db:convert-type --all-apps --clear-schema pgsql $db_name 127.0.0.1 $db_name --password=$db_pwd -n
        ynh_mysql_remove_db --db_user=$db_user --db_name=$db_name
    fi
fi

#=================================================
# DOWNLOAD, CHECK AND UNPACK SOURCE
#=================================================

# Define a function to add an external storage
# Create the external storage for the given folders and enable sharing
create_external_storage() {
local mount_dir="$1"
local mount_name="$2"
local mount_id=$(exec_occ files_external:create --output=json \
    "$mount_name" 'local' 'null::null' -c "datadir=$mount_dir" || true)
! [[ $mount_id =~ ^[0-9]+$ ]] \
    && ynh_print_warn --message="Unable to create external storage" \
    || exec_occ files_external:option "$mount_id" enable_sharing true
}

if [ "$upgrade_type" == "UPGRADE_APP" ]
then
    ynh_script_progression --message="Upgrading $app..." --weight=3

    # Load the last available version
    source upgrade.d/upgrade.last.sh
    last_version=$next_version

    last_major_version=${last_version%%.*}

    # Set write access for the following commands
    chown -R $app: "$install_dir" "$data_dir"

    # Print the current version number of Nextcloud
    exec_occ -V


    # Upgrade may fail if this app is enabled
    # Take all apps enabled, and check if mail is one of them
    # Then temporary disable the mail app
    mail_app_must_be_reactived=0
    
    if exec_occ app:list | awk '/Enabled/{f=1;next} /Disabled/{f=0} f' | grep -q -w mail; then
        exec_occ app:disable mail
        mail_app_must_be_reactived=1
    fi
    
    # While the current version is not the last version, do an upgrade
    while [ "$last_version" != "$current_version" ]
    do

        # The major version is the first part of the version number
        current_major_version=${current_version%%.*}

        if [ ! -f upgrade.d/upgrade.$current_major_version.sh ]; then
            source upgrade.d/upgrade.last.sh
        else
            source upgrade.d/upgrade.$current_major_version.sh
        fi

        # If the current version has the same major version than the next one,
        # then it's the last upgrade to do
        # We also cover the case where the last version is the first of the current major version series
        if [[ ("$last_major_version" -eq "$current_major_version") || ( ("$last_major_version" -eq "$((current_major_version+1))") && ("$next_version" == "$last_version") ) ]]; then
            current_major_version=last
            # Enable YunoHost patches on Nextcloud sources
            cp -a ../sources/patches_last_version/* ../sources/patches
        fi

        # Load the value for this version
        source upgrade.d/upgrade.$current_major_version.sh

        ynh_print_info --message="Upgrade to $app $next_version"

        # Create an app.src for this version of Nextcloud
        cat > ../conf/app.src << EOF
SOURCE_URL=https://download.nextcloud.com/server/releases/nextcloud-$next_version.tar.bz2
SOURCE_SUM=$nextcloud_source_sha256
SOURCE_SUM_PRG=sha256sum
SOURCE_FORMAT=tar.bz2
SOURCE_IN_SUBDIR=true
EOF

        # Create a temporary directory
        tmpdir="$(ynh_smart_mktemp min_size=300)"

        # Install the next nextcloud version in $tmpdir
        ynh_setup_source --dest_dir="$tmpdir"

        # Backup the config file in the temp dir
        cp -a "$install_dir/config/config.php" "$tmpdir/config/config.php"

        # Enable maintenance mode
        exec_occ maintenance:mode --on

        # Backup 3rd party applications from the current Nextcloud
        # But do not overwrite if there is any upgrade
        # (apps directory already exists in Nextcloud archive)
        (
        cd $install_dir/apps
        for nc_app_dir in */
        do
          if [ ! -d "$tmpdir/apps/$nc_app_dir" ]
          then
            cp -a "$nc_app_dir" "$tmpdir/apps/$nc_app_dir"
          fi
        done
        )

        # Replace the old Nextcloud by the new one
        ynh_secure_remove --file="$install_dir"
        mv "$tmpdir" "$install_dir"
        ynh_secure_remove --file="$tmpdir"

        # Set write access for the following commands
        chown -R $app: "$install_dir" "$data_dir"

        # Upgrade Nextcloud (SUCCESS = 0, UP_TO_DATE = 3)
        exec_occ maintenance:mode --off
        exec_occ upgrade \
        || [ $? -eq 3 ] || ynh_die --message="Unable to upgrade $app"

        # Get the new current version number
        current_version=$(grep OC_VersionString "$install_dir/version.php" | cut -d\' -f2)
        current_major_version=${current_version%%.*}

        # Print the current version number of Nextcloud
        exec_occ -V
    done

    exec_occ db:add-missing-indices -n
    exec_occ db:add-missing-columns -n
    exec_occ db:add-missing-primary-keys -n
    exec_occ db:convert-filecache-bigint -n
    
    #=================================================
    # CONFIGURE NEXTCLOUD
    #=================================================
    ynh_script_progression --message="Reconfiguring $app..." --weight=9

    # Verify the checksum and backup the file if it's different
    ynh_backup_if_checksum_is_different --file="$install_dir/config/config.php"

    nc_conf="${install_dir}/config.json"
    ynh_add_config --template="config.json" --destination="$nc_conf"

    # Reneable the mail app
    if [ $mail_app_must_be_reactived -eq 1 ]; then
        exec_occ app:enable mail
    fi

    # Ensure that UpdateNotification app is disabled
    exec_occ app:disable updatenotification

    # Enable LDAP plugin
    exec_occ app:enable user_ldap

    # Update all installed apps
    exec_occ app:update --all

    # Load the config file in nextcloud
    exec_occ config:import "$nc_conf"

    # Then remove the config file
    ynh_secure_remove --file="$nc_conf"

    #=================================================
    # ALLOW USERS TO DISCONNECT FROM NEXTCLOUD
    #=================================================

    # Add dynamic logout URL to the config
    exec_occ config:system:get logout_url >/dev/null 2>&1 \
    || echo "
    //-YunoHost-
    // set logout_url according to main domain
    \$main_domain = exec('cat /etc/yunohost/current_host');
    \$CONFIG['logout_url'] = 'https://'.\$main_domain.'/yunohost/sso/?action=logout';
    //-YunoHost-
    " >> "$install_dir/config/config.php"

    #=================================================
    # CHANGE HOSTNAME FOR ACTIVITY NOTIFICATIONS
    #=================================================

    exec_occ config:system:set overwrite.cli.url --value="https://${domain}${path}"

    #=================================================
    # MOUNT HOME FOLDERS AS EXTERNAL STORAGE
    #=================================================

    # Enable External Storage and create local mount to home folder as needed
    if [ $user_home -eq 1 ]; then
        exec_occ app:enable files_external
        exec_occ files_external:list --output=json \
        | grep -q '"storage":"\\\\OC\\\\Files\\\\Storage\\\\Local"' \
        || create_external_storage "/home/\$user" "Home"
        # Iterate over users to extend their home folder permissions
        for u in $(ynh_user_list); do
        setfacl --modify g:$app:rwx "/home/$u" || true
        done
    fi

    #=================================================
    # STORE THE CHECKSUM OF THE CONFIG FILE
    #=================================================

    # Calculate and store the config file checksum into the app settings
    ynh_store_file_checksum --file="${install_dir}/config/config.php"
fi

#=================================================
# REGEN PERMISSIONS
#=================================================
ynh_script_progression --message="Reapplying file permissions..." --weight=2

# Fix app ownerships & permissions
chown -R $app:www-data "$install_dir"
chown -R $app: "$data_dir"
find $install_dir/ -type f -print0 | xargs -r0 chmod 0644
find $install_dir/ -type d -print0 | xargs -r0 chmod 0755
find $data_dir/data/ -type f -print0 | xargs -r0 chmod 0640
find $data_dir/data/ -type d -print0 | xargs -r0 chmod 0750
chmod 640 "$install_dir/config/config.php"
chmod 755 /home/yunohost.app
chmod 750 $install_dir

#=================================================
# REGEN SYSTEM CONFIGURATIONS
#=================================================
ynh_script_progression --message="Regenerating system configurations for $app..." --weight=2

#-------------------------------------------------
# PHP-FPM
#-------------------------------------------------

ynh_add_fpm_config

#-------------------------------------------------
# NGINX
#-------------------------------------------------

# Delete current NGINX configuration to be able to check if .well-known is already served.
ynh_backup_if_checksum_is_different --file="/etc/nginx/conf.d/$domain.d/$app.conf"
ynh_remove_nginx_config
ynh_app_setting_delete --app=$app --key="checksum__etc_nginx_conf.d_$domain.d_$app.conf"

# Wait untils NGINX has fully reloaded
ynh_systemd_action --service_name=nginx --action=reload --line_match="Reloaded" --log_path="systemd"

# Check if .well-known is available for this domain
if is_url_handled --domain="$domain" --path="/.well-known/caldav" || is_url_handled --domain="$domain" --path="/.well-known/carddav"
then
    ynh_print_warn --message="Another app already uses the domain $domain to serve a CalDAV/CardDAV feature. You may encounter issues when dealing with your calendar or address book."

    # Remove lines about .well-known/carddav and caldav with sed.
    sed --in-place --regexp-extended '/location = \/\.well\-known\/(caldav|carddav)/d' "../conf/nginx.conf"
fi

# Create a dedicated NGINX config
ynh_add_nginx_config

#-------------------------------------------------
# CRON JOB
#-------------------------------------------------

cron_path="/etc/cron.d/$app"
ynh_add_config --template="nextcloud.cron" --destination="$cron_path"
chown root: "$cron_path"
chmod 644 "$cron_path"

exec_occ background:cron

#-------------------------------------------------
# LOGROTATE
#-------------------------------------------------

ynh_use_logrotate --non-append

#-------------------------------------------------
# FAIL2BAN
#-------------------------------------------------

# Create a dedicated Fail2Ban config
ynh_add_fail2ban_config --logpath="$data_dir/data/nextcloud.log" --failregex="^.*Login failed: '.*' \(Remote IP: '<HOST>'.*$" --max_retry=5

#=================================================
# END OF SCRIPT
#=================================================

ynh_script_progression --message="Upgrade of $app completed" --last
